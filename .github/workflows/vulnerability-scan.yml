# =============================================================================
# Dependency Vulnerability Scan
# Runs npm audit on backend and all frontend applications on a weekly schedule
# and on every push to main. Generates artifacts for compliance evidence.
# =============================================================================

name: Dependency Vulnerability Scan

on:
  schedule:
    # Run every Monday at 8:00 AM UTC
    - cron: '0 8 * * 1'
  push:
    branches: [main]
    paths:
      - '**/package.json'
      - '**/package-lock.json'
  workflow_dispatch:  # Allow manual trigger

jobs:
  audit-backend:
    name: Audit Backend Dependencies
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run npm audit (high + critical)
        run: |
          echo "## Backend Audit Report - $(date -u +'%Y-%m-%d %H:%M UTC')" > audit-report.txt
          echo "" >> audit-report.txt
          npm audit --audit-level=high 2>&1 | tee -a audit-report.txt || true
          echo "" >> audit-report.txt
          echo "## Summary" >> audit-report.txt
          npm audit --json 2>/dev/null | jq '{
            vulnerabilities: .metadata.vulnerabilities,
            dependencies: .metadata.dependencies
          }' >> audit-report.txt 2>/dev/null || echo "JSON summary unavailable" >> audit-report.txt

      - name: Check for critical/high vulnerabilities
        run: |
          # Fail the job if high or critical vulnerabilities are found
          npm audit --audit-level=high
        continue-on-error: true
        id: audit_check

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: backend-audit-report-${{ github.run_number }}
          path: backend/audit-report.txt
          retention-days: 90

      - name: Create issue on failure
        if: steps.audit_check.outcome == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸ”’ Vulnerability Alert: Backend dependencies (${new Date().toISOString().split('T')[0]})`;
            const body = `The weekly vulnerability scan found high or critical vulnerabilities in backend dependencies.\n\nRun \`cd backend && npm audit\` locally for details.\n\nPer patching SLA:\n- **Critical (CVSS 9.0+)**: Patch within 72 hours\n- **High (CVSS 7.0-8.9)**: Patch within 2 weeks`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['security', 'vulnerability']
            });

  audit-frontends:
    name: Audit Frontend Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app:
          - site_back_office
          - site_herds_and_flocks
          - site_restaurant_pos
          - site_point_of_sale_terminal
          - site_kitchen_display_system
          - site_onboarding
          - site_website_ecommerce
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ${{ matrix.app }}
        run: npm ci --ignore-scripts 2>/dev/null || npm install --ignore-scripts

      - name: Run npm audit
        working-directory: ${{ matrix.app }}
        run: |
          echo "## ${{ matrix.app }} Audit - $(date -u +'%Y-%m-%d %H:%M UTC')" > audit-report.txt
          npm audit --audit-level=high 2>&1 | tee -a audit-report.txt || true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-audit-${{ github.run_number }}
          path: ${{ matrix.app }}/audit-report.txt
          retention-days: 90
